# 视频分段变速处理工具

## 功能说明

这个工具可以对视频的不同片段应用不同的播放速度，实现更灵活的视频节奏控制。

### 主要特性

- ✅ 支持对视频的不同时间段设置不同的播放速度
- ✅ 自动处理音频同步（音频速度随视频同步调整）
- ✅ 支持任意播放速度（0.5x - 2.0x 及更大范围）
- ✅ 自动填充未指定的时间段（保持原速）
- ✅ 支持 JSON 配置文件

## 快速开始

### 1. 准备配置文件

创建一个 JSON 配置文件，例如 `speed_config.json`：

```json
{
    "part": [
        {
            "timestamp": "00:00:50 - 00:01:00",
            "speed": 1.2
        },
        {
            "timestamp": "00:01:00 - 00:01:10",
            "speed": 1.0
        },
        {
            "timestamp": "00:01:10 - 00:01:20",
            "speed": 1.3
        }
    ]
}
```

### 2. 运行处理脚本

```bash
# 使用 Shell 脚本（推荐）
./adjust_speed.sh input.mp4 speed_config.json output.mp4

# 或者直接使用 Python 脚本
python3 src/speed_adjuster.py input.mp4 speed_config.json output.mp4
```

## 配置文件格式

### 基本结构

```json
{
    "part": [
        {
            "timestamp": "开始时间 - 结束时间",
            "speed": 播放速度
        }
    ]
}
```

### 字段说明

- **timestamp**: 时间范围，格式为 "开始 - 结束"
  - 支持格式：`HH:MM:SS`、`MM:SS`、`SS`
  - 示例：`"00:01:30 - 00:02:00"`、`"1:30 - 2:00"`、`"90 - 120"`

- **speed**: 播放速度倍数
  - `1.0` = 正常速度
  - `> 1.0` = 加快播放（如 `1.5` 表示 1.5 倍速）
  - `< 1.0` = 减慢播放（如 `0.8` 表示 0.8 倍速）
  - 理论上支持任意速度，但建议在 `0.5 - 2.0` 范围内以获得最佳效果

### 完整示例

```json
{
    "part": [
        {
            "timestamp": "00:00:00 - 00:00:30",
            "speed": 1.0,
            "comment": "片头保持正常速度"
        },
        {
            "timestamp": "00:00:30 - 00:01:00",
            "speed": 1.5,
            "comment": "加快播放"
        },
        {
            "timestamp": "00:01:00 - 00:01:30",
            "speed": 0.8,
            "comment": "减慢播放，突出重点"
        },
        {
            "timestamp": "00:01:30 - 00:02:00",
            "speed": 1.2,
            "comment": "略微加快"
        }
    ]
}
```

## 使用场景

### 1. 跳过无关内容
加快无关紧要部分的播放速度，保持关键内容的正常速度。

```json
{
    "part": [
        {
            "timestamp": "00:00:30 - 00:01:30",
            "speed": 1.5,
            "comment": "跳过重复内容"
        }
    ]
}
```

### 2. 强调重点内容
减慢重要片段的播放速度，让观众更容易理解。

```json
{
    "part": [
        {
            "timestamp": "00:02:00 - 00:02:30",
            "speed": 0.7,
            "comment": "减慢重点讲解部分"
        }
    ]
}
```

### 3. 节奏调整
根据视频内容的节奏调整不同部分的速度。

```json
{
    "part": [
        {
            "timestamp": "00:00:00 - 00:00:15",
            "speed": 1.0,
            "comment": "开场正常"
        },
        {
            "timestamp": "00:00:15 - 00:01:00",
            "speed": 1.3,
            "comment": "加快介绍"
        },
        {
            "timestamp": "00:01:00 - 00:02:00",
            "speed": 1.0,
            "comment": "主要内容正常"
        },
        {
            "timestamp": "00:02:00 - 00:02:30",
            "speed": 1.5,
            "comment": "加快结尾"
        }
    ]
}
```

## 技术实现

### 工作原理

1. **片段切割**: 根据配置将视频切割成多个片段
2. **速度调整**: 
   - 视频：使用 FFmpeg 的 `setpts` 滤镜调整时间戳
   - 音频：使用 `atempo` 滤镜调整音频速度（保持音调）
3. **自动填充**: 未指定的时间段自动保持原速
4. **片段拼接**: 将所有处理后的片段无缝拼接

### FFmpeg 滤镜说明

- **setpts**: 调整视频的 PTS（Presentation Time Stamp）
  - `setpts=0.5*PTS` → 2 倍速
  - `setpts=2.0*PTS` → 0.5 倍速

- **atempo**: 调整音频速度（不改变音调）
  - `atempo=1.5` → 1.5 倍速
  - `atempo=0.8` → 0.8 倍速
  - 支持范围：0.5 - 2.0，超出范围会自动链式调用

## 常见问题

### Q: 为什么有些时间段我没有配置，但也被处理了？

A: 工具会自动填充未配置的时间段，保持原速播放，以确保输出视频的完整性。

### Q: 支持的速度范围是多少？

A: 理论上支持任意速度，但 `atempo` 滤镜单次只支持 0.5-2.0。工具会自动处理超出范围的速度（通过链式调用）。

### Q: 音频会变调吗？

A: 不会。使用 `atempo` 滤镜会保持音调，只改变速度。

### Q: 处理大文件需要多久？

A: 处理时间取决于视频长度、分段数量和速度配置。通常每个片段的处理时间约为片段时长的 1-2 倍。

### Q: 可以同时加快多个不连续的片段吗？

A: 可以！只需在配置中添加多个 `part` 对象，工具会自动处理所有片段。

## 命令行选项

### Shell 脚本

```bash
./adjust_speed.sh <输入视频> <配置JSON文件> [输出视频]
```

- 输入视频: 必需，要处理的视频文件
- 配置JSON文件: 必需，包含速度配置
- 输出视频: 可选，默认为 `<输入视频>_speed_adjusted.mp4`

### Python 脚本

```bash
python3 src/speed_adjuster.py <输入视频> <配置JSON> <输出视频>
```

配置可以是：
- JSON 文件路径
- JSON 字符串

## 依赖要求

- Python 3.6+
- FFmpeg 4.0+（需要支持 `setpts` 和 `atempo` 滤镜）

## 注意事项

1. **临时空间**: 处理过程会在 `/tmp/video_speed_segments/` 创建临时文件，确保有足够的磁盘空间
2. **编码质量**: 默认使用原视频的编码参数，质量与原视频相当
3. **时间精度**: 时间戳精确到秒级，如需更高精度可使用小数（如 `90.5`）
4. **覆盖输出**: 输出文件如已存在会被自动覆盖

## 示例文件

项目包含一个示例配置文件 `speed_config_example.json`，可以作为参考。

